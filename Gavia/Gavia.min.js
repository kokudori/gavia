(function(a){"use strict";var b=function(a,c,d){if(!(this instanceof b))return new b(a,c,d);if(!a)throw"require database name";"undefined"==typeof d&&(d=c,c=1),Object.defineProperties(this,{name:{enumerable:!0,value:a},version:{enumerable:!0,value:c}}),e.create(a,c,d),Object.defineProperties(this,Object.keys(d).reduce(function(b,f){return b[f]={enumerable:!0,value:e(f,a,c,d[f])},b},{})),Object.defineProperty(b,a,{enumerable:!0,configurable:!0,value:this})};Object.defineProperties(b,{fn:{value:{}},Store:{value:Object.create(null,{fn:{value:{}}})},Record:{value:Object.create(null,{fn:{value:{}}})}}),b.Deffered=function(){var a={pending:"pending",resolved:"resolved",rejected:"rejected"},b=function(){return this instanceof b?(this.state=a.pending,this.dones=[],this.fails=[],void 0):new b};return b.when=function(){var a=arguments[0]instanceof Array?arguments[0]:[].slice.apply(arguments),c=a.length,d=new b;return a.forEach(function(a){a.done(function(){c-=1,0===c&&d.resolve()}).fail(function(){d.reject.apply(d,arguments)})}),d},b.prototype={resolve:function(){var b=arguments;return this.state===a.pending&&(this.state=a.resolved,this.dones.forEach(function(a){a.apply(null,b)})),this},reject:function(){var b=arguments;return this.state===a.pending&&(this.state=a.rejected,this.fails.forEach(function(a){a.apply(null,b)})),this},done:function(b){return this.state===a.pending&&this.dones.push(b),this},fail:function(b){return this.state===a.pending&&this.fails.push(b),this},then:function(a,c){var d=new b;return this.done(function(){var b=a.apply(null,arguments);b.done?b.done(function(){d.resolve.apply(d,arguments)}):d.resolve(b)}).fail(function(){var a=c.apply(null,arguments);a.fail?a.fail(function(){d.reject.apply(d,arguments)}):d.reject(a)}),d},promise:function(){var a=this;return{done:function(){return b.prototype.done.apply(a,arguments)},fail:function(){return b.prototype.fail.apply(a,arguments)},then:function(c,d){return b.prototype.then.call(a,c,d)}}}},b}();{var c=this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.msIndexedDB,d=(this.IDBTransaction||this.webkitIDBTransaction||this.msIDBTransaction,this.IDBKeyRange||this.webkitIDBKeyRange||this.msIDBKeyRange);this.IDBCursor||this.webkitIDBCursor||this.msIDBCursor}b.prototype.all=function(){return Object.keys(this).filter(function(a){return"name"!==a&&"version"!==a}).map(function(a){return this[a]}.bind(this))},b.prototype.delete=function(){var a=$.Deferred(),d=c.deleteDatabase(this.name);return d.onsuccess=function(){a.resolve(this.name)}.bind(this),d.onerror=function(){a.reject(this.name)}.bind(this),delete b[this.name],a.promise()};var e=function(a,b,c,d){return this instanceof e?(Object.keys(d).filter(function(a){return"keyPath"===a||"autoIncrement"===a}).forEach(function(a){Object.defineProperty(this,a,{enumerable:!0,value:d[a]})}.bind(this)),Object.defineProperties(this,{name:{enumerable:!0,value:a},db:{value:Object.create(null,{name:{value:b},version:{value:c}})},fn:{value:{}}}),void 0):new e(a,b,c,d)};e.prototype=b.Store.fn,Object.defineProperty(b.Store,"direction",{enumerable:!0,value:Object.create(null,{next:{enumerable:!0,value:"next"},nextUnique:{enumerable:!0,value:"nextunique"},prev:{enumerable:!0,value:"prev"},prevUnique:{enumerable:!0,value:"prevunique"}})});var f=function(a,b){var c=b.index.keyPath||b.keyPath,d=b.index.name||c,e=["unique","multiEntry"].reduce(function(a,c){return"undefined"!=typeof b.index[c]&&(a[c]=b.index[c]),a},{});a.createIndex(d,c,e)},g=function(a,b,c){c=$.extend({keyPath:null,autoIncrement:!1,index:null},c),a.objectStoreNames.contains(b)&&a.deleteObjectStore(b);var d=a.createObjectStore(b,{keyPath:c.keyPath,autoIncrement:c.autoIncrement});c.index&&f(d,c)};e.create=function(a,b,d){var e=c.open(a,b);e.onupgradeneeded=function(a){var b=a.target.result;Object.keys(d).forEach(function(a){g(b,a,d[a])}),b.close()}},b.Store.fn.all=function(a){if(!a||a.count!==!0)return this.filter(function(){return!0},a);var b=$.Deferred(),d=c.open(this.db.name,this.db.version);return a=$.extend({index:null,offset:0,limit:null},a),d.onsuccess=function(c){var d,e=c.target.result,f=e.transaction([this.name],"readonly").objectStore(this.name);a.index&&(f=f.index(a.index)),d=f.count(),d.onsuccess=function(c){var d=c.target.result,f=a.limit||d;d=a.offset>d?0:d-a.offset,d=f>=d?d:f,b.resolve(d),e.close()}.bind(this),d.onerror=function(a){var c=a.target.result;b.reject(key),c.close()},e.close()}.bind(this),d.onerror=function(a){var c=a.target.result;b.reject(),c.close()},b.promise()};var h=function(a,b,c,d,f){var g=[];return e.fetch(a,c,b,function(b,c,d){return b?(c>d.offset&&g.push(a.create().update(b.value)),(d.limit?d.limit+d.offset>c:!0)?(b.continue(),void 0):function(){return g}):function(){return g}},d,f)};b.Store.fn.upper=function(a,b){return h(this,a,"lower",b)},b.Store.fn.upperThan=function(a,b){return h(this,a,"lowerThan",b)},b.Store.fn.lower=function(a,b){return h(this,a,"upper",b)},b.Store.fn.lowerThan=function(a,b){return h(this,a,"upperThan",b)},b.Store.fn.bound=function(a,b,c){return h(this,a,"bound",c,b)},b.Store.fn.boundThan=function(a,b,c){return h(this,a,"boundThan",c,b)},b.Store.fn.clear=function(){var a=$.Deferred(),b=c.open(this.db.name,this.db.version);return b.onsuccess=function(b){var c=b.target.result,d=c.transaction([this.name],"readwrite"),e=d.objectStore(this.name).clear();e.onsuccess=function(){a.resolve(),c.close()},e.onerror=function(){a.reject(),c.close()}}.bind(this),b.onerror=function(b){var c=b.target.result;a.reject(),c.close()},a.promise()},b.Store.fn.create=function(a){var b=j(this,this.db,this.fn);return this.keyPath&&a?(b[this.keyPath]=a,b):b},b.Store.fn.delete=function(a){return this.find(a).then(function(b){return b?b.delete(function(){return a}):$.Deferred().reject(a).promise()})},e.getKeyRange=function(a,b,c){switch(a){case"upper":return d.upperBound(b);case"upperThan":return d.upperBound(b,!0);case"lower":return d.lowerBound(b);case"lowerThan":return d.lowerBound(b,!0);case"bound":return d.bound(b,c);case"boundThan":return d.bound(b,c,!0,!0);case"only":return d.only(b);case"filter":return null;default:throw"no match"}},e.fetch=function(a,d,f,g,h,i){var j=$.Deferred(),k=c.open(a.db.name,a.db.version);return h=$.extend({direction:b.Store.direction.next,index:null,offset:0,limit:null},h),k.onsuccess=function(b){var c,k=1,l=e.getKeyRange(d,f,i),m=b.target.result,n=m.transaction([a.name],"readonly").objectStore(a.name);return h.index&&(n=n.index(h.index)),h.count&&"filter"!==d?(c=n.count(l),c.onsuccess=function(a){var b=a.target.result,c=h.limit||b;b=h.offset>b?0:b-h.offset,b=c>=b?b:c,j.resolve(b),m.close()},c.onerror=function(){j.reject(),m.close()},void 0):(c=n.openCursor(l,h.direction),c.onsuccess=function(a){var b=a.target.result,c=g(b,k,h);return"function"==typeof c?(j.resolve(c()),m.close(),void 0):(k+=1,void 0)},c.onerror=function(){j.reject(),m.close()},void 0)},k.onerror=function(a){var b=a.target.result;j.reject(),b.close()},j.promise()},b.Store.fn.filter=function(b,c){var d=this,f=[];if("function"!=typeof b){var g=b;return e.fetch(this,"only",g,function(b,c,e){return b||c>e.offset?function(){return b?e.count?1:d.create().update(b.value):e.count?0:a}:((e.limit?e.limit+e.offset>c:!0)&&b.continue(),void 0)},c)}return e.fetch(this,"filter",b,function(a,c,e){return a?(c>e.offset&&b(a.value)===!0&&(e.count?f.push(1):f.push(d.create().update(a.value))),(e.limit?e.limit+e.offset>c:!0)?(a.continue(),void 0):function(){return e.count?f.length:f}):function(){return e.count?f.length:f}},c)},b.Store.fn.find=function(a,b){var d=$.Deferred(),e=c.open(this.db.name,this.db.version);return e.onsuccess=function(c){var e,f=c.target.result,g=f.transaction([this.name],"readonly").objectStore(this.name);b&&b.index&&(g=g.index(b.index)),e=g.get(a),e.onsuccess=function(a){var b=a.target.result;return"undefined"==typeof b?(d.resolve(b),f.close(),void 0):(d.resolve(this.create().update(b)),f.close(),void 0)}.bind(this),e.onerror=function(b){var c=b.target.result;d.reject(a),c.close()}}.bind(this),e.onerror=function(b){var c=b.target.result;d.reject(a),c.close()},d.promise()};var i=function(a){return{add:function(b,c){c&&(a.add(b,c).onerror=function(){console.log("errored")}),a.add(b).onerror=function(){console.log("errored")}},put:function(b,c){c&&a.put(b,c),a.put(b)},remove:function(b){a.delete(b)}}};b.Store.fn.transaction=function(){var a=[].slice.apply(arguments),b=[this].concat(a.splice(0,a.length-1)),d=a[a.length-1],e=$.Deferred(),f=c.open(this.db.name,this.db.version);return f.onsuccess=function(a){var c=a.target.result,f=b.map(function(a){return a.name}),g=c.transaction(f,"readwrite"),h=d.apply(null,b.map(function(a){return i(g.objectStore(a.name))}));g.oncomplete=function(){e.resolve(),c.close()},g.onerror=function(){h!==!1?e.reject():e.resolve(),c.close()},h===!1&&g.abort()}.bind(this),f.onerror=function(a){var b=a.target.result;e.reject(),b.close()},e.promise()},b.Record.fn.delete=function(a){var b,d=$.Deferred(),e=function(){return this.store.keyPath?this[this.store.keyPath]:"function"==typeof a?a():a?this[a]:void 0}.apply(this);return e?(b=c.open(this.db.name,this.db.version),b.onsuccess=function(a){var b=a.target.result,c=b.transaction([this.store.name],"readwrite").objectStore(this.store.name);c.delete(e),c.transaction.oncomplete=function(){d.resolve(e),b.close()},c.transaction.onerror=function(){d.reject(e),b.close()}}.bind(this),b.onerror=function(a){var b=a.target.result;d.reject(),b.close()},d.promise()):(d.reject("key does not setting."),d.promise())},b.Record.fn.isExist=function(a){var b=a||this.store.keyPath;return"function"==typeof a?this.store.filter(a,{count:!0}).then(function(a){return a>0}):this.store.find(this[b]).then(function(a){return"undefined"!=typeof a})};var j=function(a,b,c){return this instanceof j?(Object.defineProperties(this,{store:{value:a},db:{value:b}}),Object.keys(a).filter(function(a){return"keyPath"===a||"autoIncrement"===a}).forEach(function(b){Object.defineProperty(this.store,b,{value:a[b]})}.bind(this)),$.extend(Object.getPrototypeOf(this),c),void 0):new j(a,b,c)};j.prototype=b.Record.fn,b.Record.fn.save=function(a){var b=$.Deferred(),d=c.open(this.db.name,this.db.version);return d.onsuccess=function(c){var d,e=c.target.result,f=e.transaction([this.store.name],"readwrite").objectStore(this.store.name),g=Object.keys(this).reduce(function(a,b){return a[b]=this[b],a}.bind(this),{}),h=function(){return a?f.put(g,a):f.put(g)}();h.onsuccess=function(a){d=a.target.result},f.transaction.oncomplete=function(){b.resolve(d),e.close()},f.transaction.onerror=function(){b.reject(),e.close()}}.bind(this),d.onerror=function(a){var c=a.target.result;b.reject(),c.close()}.bind(this),Object.defineProperty(this,"promise",{writable:!0,value:b.promise()})},b.Record.fn.update=function(a){return Object.keys(a).forEach(function(b){this[b]=a[b]}.bind(this)),this},window.Gavia=b}).call(this);