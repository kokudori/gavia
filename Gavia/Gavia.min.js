(function(a){"use strict";var b=function(a,c,d){if(!(this instanceof b))return new b(a,c,d);if(!a)throw"require database name";"undefined"==typeof d&&(d=c,c=1),Object.defineProperties(this,{name:{enumerable:!0,value:a},version:{enumerable:!0,value:c}}),f.create(a,c,d),Object.defineProperties(this,Object.keys(d).reduce(function(b,e){return b[e]={enumerable:!0,value:f(e,a,c,d[e])},b},{})),Object.defineProperty(b,a,{enumerable:!0,configurable:!0,value:this})};Object.defineProperties(b,{fn:{value:{}},Store:{value:Object.create(null,{fn:{value:{}}})},Record:{value:Object.create(null,{fn:{value:{}}})}}),b.Deferred=function(){var a={pending:"pending",resolved:"resolved",rejected:"rejected"},b=function(){return this instanceof b?(this.state=a.pending,this.resolved=null,this.rejected=null,this.dones=[],this.fails=[],void 0):new b};return b.when=function(){var a=arguments[0]instanceof Array?arguments[0]:[].slice.apply(arguments),c=[],d=new b;return a.forEach(function(b){b.done(function(){var b=1===arguments.length?arguments[0]:[].slice.apply(arguments);c.push(b),c.length===a.length&&d.resolve.apply(d,c)}).fail(function(){d.reject.apply(d,arguments)})}),d},b.prototype={resolve:function(){var b=arguments;return this.state===a.pending&&(this.state=a.resolved,this.resolved=b,this.dones.forEach(function(a){a.apply(null,b)})),this},reject:function(){var b=arguments;return this.state===a.pending&&(this.state=a.rejected,this.rejected=b,this.fails.forEach(function(a){a.apply(null,b)})),this},done:function(b){return this.state===a.pending?this.dones.push(b):this.state===a.resolved&&b.apply(null,this.resolved),this},fail:function(b){return this.state===a.pending?this.fails.push(b):this.state===a.rejected&&b.apply(null,this.rejected),this},then:function(a,c){var d=new b;return this.done(function(){var b=a.apply(null,arguments);b.done&&b.fail?b.done(function(){d.resolve.apply(d,arguments)}).fail(function(){d.reject.apply(d,arguments)}):d.resolve(b)}).fail(function(){var a=c.apply(null,arguments);a.done&&a.fail?a.done(function(){d.resolve.apply(d,arguments)}).fail(function(){d.reject.apply(d,arguments)}):d.reject(a)}),d},promise:function(){var a=this;return{done:function(){return b.prototype.done.apply(a,arguments)},fail:function(){return b.prototype.fail.apply(a,arguments)},then:function(c,d){return b.prototype.then.call(a,c,d)}}}},b}();{var c=function(a,b){var c={};return Object.keys(b||{}).forEach(function(a){c[a]={value:b[a]}}),Object.create(a,c)},d=this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.msIndexedDB,e=(this.IDBTransaction||this.webkitIDBTransaction||this.msIDBTransaction,this.IDBKeyRange||this.webkitIDBKeyRange||this.msIDBKeyRange);this.IDBCursor||this.webkitIDBCursor||this.msIDBCursor}b.prototype.all=function(){return Object.keys(this).filter(function(a){return"name"!==a&&"version"!==a}).map(function(a){return this[a]}.bind(this))},b.prototype.delete=function(){var a=new b.Deferred,c=d.deleteDatabase(this.name);return c.onsuccess=function(){a.resolve(this.name)}.bind(this),c.onerror=function(){a.reject(this.name)}.bind(this),delete b[this.name],a.promise()};var f=function(a,b,c,d){return this instanceof f?(Object.keys(d).filter(function(a){return"keyPath"===a||"autoIncrement"===a}).forEach(function(a){Object.defineProperty(this,a,{enumerable:!0,value:d[a]})}.bind(this)),Object.defineProperties(this,{name:{enumerable:!0,value:a},db:{value:Object.create(null,{name:{value:b},version:{value:c}})},fn:{value:{}}}),void 0):new f(a,b,c,d)};f.prototype=b.Store.fn,Object.defineProperty(b.Store,"direction",{enumerable:!0,value:Object.create(null,{next:{enumerable:!0,value:"next"},nextUnique:{enumerable:!0,value:"nextunique"},prev:{enumerable:!0,value:"prev"},prevUnique:{enumerable:!0,value:"prevunique"}})});var g=function(a,b){var c=b.index.keyPath||b.keyPath,d=b.index.name||c,e=["unique","multiEntry"].reduce(function(a,c){return"undefined"!=typeof b.index[c]&&(a[c]=b.index[c]),a},{});a.createIndex(d,c,e)},h=function(a,b,d){d=c({keyPath:null,autoIncrement:!1,index:null},d),a.objectStoreNames.contains(b)&&a.deleteObjectStore(b);var e=a.createObjectStore(b,{keyPath:d.keyPath,autoIncrement:d.autoIncrement});d.index&&g(e,d)};f.create=function(a,b,c){var e=d.open(a,b);e.onupgradeneeded=function(a){var b=a.target.result;Object.keys(c).forEach(function(a){h(b,a,c[a])}),b.close()}},b.Store.fn.all=function(a){if(!a||a.count!==!0)return this.filter(function(){return!0},a);var e=new b.Deferred,f=d.open(this.db.name,this.db.version);return a=c({index:null,offset:0,limit:null},a),f.onsuccess=function(b){var c,d=b.target.result,f=d.transaction([this.name],"readonly").objectStore(this.name);a.index&&(f=f.index(a.index)),c=f.count(),c.onsuccess=function(b){var c=b.target.result,f=a.limit||c;c=a.offset>c?0:c-a.offset,c=f>=c?c:f,e.resolve(c),d.close()}.bind(this),c.onerror=function(a){var b=a.target.result;e.reject(key),b.close()},d.close()}.bind(this),f.onerror=function(a){var b=a.target.result;e.reject(),b.close()},e.promise()};var i=function(a,b,c,d,e){var g=[];return f.fetch(a,c,b,function(b,c,d){return b?(c>d.offset&&g.push(a.create().update(b.value)),(d.limit?d.limit+d.offset>c:!0)?(b.continue(),void 0):function(){return g}):function(){return g}},d,e)};b.Store.fn.upper=function(a,b){return i(this,a,"lower",b)},b.Store.fn.upperThan=function(a,b){return i(this,a,"lowerThan",b)},b.Store.fn.lower=function(a,b){return i(this,a,"upper",b)},b.Store.fn.lowerThan=function(a,b){return i(this,a,"upperThan",b)},b.Store.fn.bound=function(a,b,c){return i(this,a,"bound",c,b)},b.Store.fn.boundThan=function(a,b,c){return i(this,a,"boundThan",c,b)},b.Store.fn.clear=function(){var a=new b.Deferred,c=d.open(this.db.name,this.db.version);return c.onsuccess=function(b){var c=b.target.result,d=c.transaction([this.name],"readwrite"),e=d.objectStore(this.name).clear();e.onsuccess=function(){a.resolve(),c.close()},e.onerror=function(){a.reject(),c.close()}}.bind(this),c.onerror=function(b){var c=b.target.result;a.reject(),c.close()},a.promise()},b.Store.fn.create=function(a){var b=k(this,this.db,this.fn);return this.keyPath&&a?(b[this.keyPath]=a,b):b},b.Store.fn.delete=function(a){return this.find(a).then(function(c){return c?c.delete(function(){return a}):(new b.Deferred).reject(a).promise()})},f.getKeyRange=function(a,b,c){switch(a){case"upper":return e.upperBound(b);case"upperThan":return e.upperBound(b,!0);case"lower":return e.lowerBound(b);case"lowerThan":return e.lowerBound(b,!0);case"bound":return e.bound(b,c);case"boundThan":return e.bound(b,c,!0,!0);case"only":return e.only(b);case"filter":return null;default:throw"no match key range"}},f.fetch=function(a,e,g,h,i,j){var k=new b.Deferred,l=d.open(a.db.name,a.db.version);return i=c({direction:b.Store.direction.next,index:null,offset:0,limit:null},i),l.onsuccess=function(b){var c,d=1,l=f.getKeyRange(e,g,j),m=b.target.result,n=m.transaction([a.name],"readonly").objectStore(a.name);return i.index&&(n=n.index(i.index)),i.count&&"filter"!==e?(c=n.count(l),c.onsuccess=function(a){var b=a.target.result,c=i.limit||b;b=i.offset>b?0:b-i.offset,b=c>=b?b:c,k.resolve(b),m.close()},c.onerror=function(){k.reject(),m.close()},void 0):(c=n.openCursor(l,i.direction),c.onsuccess=function(a){var b=a.target.result,c=h(b,d,i);return"function"==typeof c?(k.resolve(c()),m.close(),void 0):(d+=1,void 0)},c.onerror=function(){k.reject(),m.close()},void 0)},l.onerror=function(a){var b=a.target.result;k.reject(),b.close()},k.promise()},b.Store.fn.filter=function(b,c){var d=this,e=[];if("function"!=typeof b){var g=b;return f.fetch(this,"only",g,function(b,c,e){return b||c>e.offset?function(){return b?e.count?1:d.create().update(b.value):e.count?0:a}:((e.limit?e.limit+e.offset>c:!0)&&b.continue(),void 0)},c)}return f.fetch(this,"filter",b,function(a,c,f){return a?(c>f.offset&&b(a.value)===!0&&(f.count?e.push(1):e.push(d.create().update(a.value))),(f.limit?f.limit+f.offset>c:!0)?(a.continue(),void 0):function(){return f.count?e.length:e}):function(){return f.count?e.length:e}},c)},b.Store.fn.find=function(a,c){var e=new b.Deferred,f=d.open(this.db.name,this.db.version);return f.onsuccess=function(b){var d,f=b.target.result,g=f.transaction([this.name],"readonly").objectStore(this.name);c&&c.index&&(g=g.index(c.index)),d=g.get(a),d.onsuccess=function(a){var b=a.target.result;return"undefined"==typeof b?(e.resolve(b),f.close(),void 0):(e.resolve(this.create().update(b)),f.close(),void 0)}.bind(this),d.onerror=function(b){var c=b.target.result;e.reject(a),c.close()}}.bind(this),f.onerror=function(b){var c=b.target.result;e.reject(a),c.close()},e.promise()};var j=function(a){return{add:function(b,c){c&&(a.add(b,c).onerror=function(){console.log("errored")}),a.add(b).onerror=function(){console.log("errored")}},put:function(b,c){c&&a.put(b,c),a.put(b)},remove:function(b){a.delete(b)}}};b.Store.fn.transaction=function(){var a=[].slice.apply(arguments),c=[this].concat(a.splice(0,a.length-1)),e=a[a.length-1],f=new b.Deferred,g=d.open(this.db.name,this.db.version);return g.onsuccess=function(a){var b=a.target.result,d=c.map(function(a){return a.name}),g=b.transaction(d,"readwrite"),h=e.apply(null,c.map(function(a){return j(g.objectStore(a.name))}));g.oncomplete=function(){f.resolve(),b.close()},g.onerror=function(){h!==!1?f.reject():f.resolve(),b.close()},h===!1&&g.abort()}.bind(this),g.onerror=function(a){var b=a.target.result;f.reject(),b.close()},f.promise()},b.Record.fn.delete=function(a){var c,e=new b.Deferred,f=function(){return this.store.keyPath?this[this.store.keyPath]:"function"==typeof a?a():a?this[a]:void 0}.apply(this);return f?(c=d.open(this.db.name,this.db.version),c.onsuccess=function(a){var b=a.target.result,c=b.transaction([this.store.name],"readwrite").objectStore(this.store.name);c.delete(f),c.transaction.oncomplete=function(){e.resolve(f),b.close()},c.transaction.onerror=function(){e.reject(f),b.close()}}.bind(this),c.onerror=function(a){var b=a.target.result;e.reject(),b.close()},e.promise()):(e.reject("key does not setting."),e.promise())},b.Record.fn.isExist=function(a){var b=a||this.store.keyPath;return"function"==typeof a?this.store.filter(a,{count:!0}).then(function(a){return a>0}):this.store.find(this[b]).then(function(a){return"undefined"!=typeof a})};var k=function(a,b,d){return this instanceof k?(Object.defineProperties(this,{store:{value:a},db:{value:b}}),Object.keys(a).filter(function(a){return"keyPath"===a||"autoIncrement"===a}).forEach(function(b){Object.defineProperty(this.store,b,{value:a[b]})}.bind(this)),c(Object.getPrototypeOf(this),d),void 0):new k(a,b,d)};k.prototype=b.Record.fn,b.Record.fn.save=function(a){var c=new b.Deferred,e=d.open(this.db.name,this.db.version);return e.onsuccess=function(b){var d,e=b.target.result,f=e.transaction([this.store.name],"readwrite").objectStore(this.store.name),g=Object.keys(this).reduce(function(a,b){return a[b]=this[b],a}.bind(this),{}),h=function(){return a?f.put(g,a):f.put(g)}();h.onsuccess=function(a){d=a.target.result},f.transaction.oncomplete=function(){c.resolve(d),e.close()},f.transaction.onerror=function(){c.reject(),e.close()}}.bind(this),e.onerror=function(a){var b=a.target.result;c.reject(),b.close()}.bind(this),Object.defineProperty(this,"promise",{writable:!0,value:c.promise()})},b.Record.fn.update=function(a){return Object.keys(a).forEach(function(b){this[b]=a[b]}.bind(this)),this},window.Gavia=b}).call(this);