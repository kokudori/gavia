(function(e){"use strict";var t=this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.msIndexedDB,n=(this.IDBTransaction||this.webkitIDBTransaction||this.msIDBTransaction,this.IDBKeyRange||this.webkitIDBKeyRange||this.msIDBKeyRange);this.IDBCursor||this.webkitIDBCursor||this.msIDBCursor;var r=function(t,n,i){if(!(this instanceof r))return new r(t,n,i);if(!t)throw"require database name";i===e&&(i=n,n=1),Object.defineProperties(this,{name:{enumerable:!0,value:t},version:{enumerable:!0,value:n}}),o.create(t,n,i),Object.defineProperties(this,Object.keys(i).reduce(function(e,r){return e[r]={enumerable:!0,value:o(r,t,n,i[r])},e},{})),Object.defineProperty(r,t,{enumerable:!0,configurable:!0,value:this})};Object.defineProperties(r,{fn:{value:{}},Store:{value:Object.create(null,{fn:{value:{}}})},Record:{value:Object.create(null,{fn:{value:{}}})}}),r.prototype.all=function(){return Object.keys(this).filter(function(e){return"name"!==e&&"version"!==e}).map(function(e){return this[e]}.bind(this))},r.prototype.delete=function(){var e=$.Deferred(),n=t.deleteDatabase(this.name);return n.onsuccess=function(){e.resolve(this.name)}.bind(this),n.onerror=function(){e.reject(this.name)}.bind(this),delete r[this.name],e.promise()};var o=function(t,n,r,i){return this instanceof o?(Object.keys(i).filter(function(e){return"keyPath"===e||"autoIncrement"===e}).forEach(function(e){Object.defineProperty(this,e,{enumerable:!0,value:i[e]})}.bind(this)),Object.defineProperties(this,{name:{enumerable:!0,value:t},db:{value:Object.create(null,{name:{value:n},version:{value:r}})},fn:{value:{}}}),e):new o(t,n,r,i)};o.prototype=r.Store.fn,Object.defineProperty(r.Store,"direction",{enumerable:!0,value:Object.create(null,{next:{enumerable:!0,value:"next"},nextUnique:{enumerable:!0,value:"nextunique"},prev:{enumerable:!0,value:"prev"},prevUnique:{enumerable:!0,value:"prevunique"}})});var i=function(t,n){var r=n.index.keyPath||n.keyPath,o=n.index.name||r,i=["unique","multiEntry"].reduce(function(t,r){return n.index[r]!==e&&(t[r]=n.index[r]),t},{});t.createIndex(o,r,i)},u=function(e,t,n){n=$.extend({keyPath:null,autoIncrement:!1,index:null},n),e.objectStoreNames.contains(t)&&e.deleteObjectStore(t);var r=e.createObjectStore(t,{keyPath:n.keyPath,autoIncrement:n.autoIncrement});n.index&&i(r,n)};o.create=function(e,n,r){var o=t.open(e,n);o.onupgradeneeded=function(e){var t=e.target.result;Object.keys(r).forEach(function(e){u(t,e,r[e])}),t.close()}},r.Store.fn.all=function(e){if(!e||e.count!==!0)return this.filter(function(){return!0},e);var n=$.Deferred(),r=t.open(this.db.name,this.db.version);return e=$.extend({index:null,offset:0,limit:null},e),r.onsuccess=function(t){var r,o=t.target.result,i=o.transaction([this.name],"readonly").objectStore(this.name);e.index&&(i=i.index(e.index)),r=i.count(),r.onsuccess=function(t){var r=t.target.result,i=e.limit||r;r=e.offset>r?0:r-e.offset,r=i>=r?r:i,n.resolve(r),o.close()}.bind(this),r.onerror=function(e){var t=e.target.result;n.reject(key),t.close()},o.close()}.bind(this),r.onerror=function(e){var t=e.target.result;n.reject(),t.close()},n.promise()};var s=function(t,n,r,i,u){var s=[];return o.fetch(t,r,n,function(n,r,o){return n?(r>o.offset&&s.push(t.create().update(n.value)),(o.limit?o.limit+o.offset>r:!0)?(n.continue(),e):function(){return s}):function(){return s}},i,u)};r.Store.fn.upper=function(e,t){return s(this,e,"lower",t)},r.Store.fn.upperThan=function(e,t){return s(this,e,"lowerThan",t)},r.Store.fn.lower=function(e,t){return s(this,e,"upper",t)},r.Store.fn.lowerThan=function(e,t){return s(this,e,"upperThan",t)},r.Store.fn.bound=function(e,t,n){return s(this,e,"bound",n,t)},r.Store.fn.boundThan=function(e,t,n){return s(this,e,"boundThan",n,t)},r.Store.fn.clear=function(){var e=$.Deferred(),n=t.open(this.db.name,this.db.version);return n.onsuccess=function(t){var n=t.target.result,r=n.transaction([this.name],"readwrite"),o=r.objectStore(this.name).clear();o.onsuccess=function(){e.resolve(),n.close()},o.onerror=function(){e.reject(),n.close()}}.bind(this),n.onerror=function(t){var n=t.target.result;e.reject(),n.close()},e.promise()},r.Store.fn.create=function(e){var t=a(this,this.db,this.fn);return this.keyPath&&e?(t[this.keyPath]=e,t):t},r.Store.fn.delete=function(e){return this.find(e).then(function(t){return t?t.delete(function(){return e}):$.Deferred().reject(e).promise()})},o.getKeyRange=function(e,t,r){switch(e){case"upper":return n.upperBound(t);case"upperThan":return n.upperBound(t,!0);case"lower":return n.lowerBound(t);case"lowerThan":return n.lowerBound(t,!0);case"bound":return n.bound(t,r);case"boundThan":return n.bound(t,r,!0,!0);case"only":return n.only(t);case"filter":return null;default:throw"no match"}},o.fetch=function(n,i,u,s,c,a){var f=$.Deferred(),l=t.open(n.db.name,n.db.version);return c=$.extend({direction:r.Store.direction.next,index:null,offset:0,limit:null},c),l.onsuccess=function(t){var r,l=1,d=o.getKeyRange(i,u,a),h=t.target.result,v=h.transaction([n.name],"readonly").objectStore(n.name);return c.index&&(v=v.index(c.index)),c.count&&"filter"!==i?(r=v.count(d),r.onsuccess=function(e){var t=e.target.result,n=c.limit||t;t=c.offset>t?0:t-c.offset,t=n>=t?t:n,f.resolve(t),h.close()},r.onerror=function(){f.reject(),h.close()},e):(r=v.openCursor(d,c.direction),r.onsuccess=function(t){var n=t.target.result,r=s(n,l,c);return"function"==typeof r?(f.resolve(r()),h.close(),e):(l+=1,e)},r.onerror=function(){f.reject(),h.close()},e)},l.onerror=function(e){var t=e.target.result;f.reject(),t.close()},f.promise()},r.Store.fn.filter=function(t,n){var r=this,i=[];if("function"!=typeof t){var u=t;return o.fetch(this,"only",u,function(t,n,o){return t||n>o.offset?function(){return t?o.count?1:r.create().update(t.value):o.count?0:e}:((o.limit?o.limit+o.offset>n:!0)&&t.continue(),e)},n)}return o.fetch(this,"filter",t,function(n,o,u){return n?(o>u.offset&&t(n.value)===!0&&(u.count?i.push(1):i.push(r.create().update(n.value))),(u.limit?u.limit+u.offset>o:!0)?(n.continue(),e):function(){return u.count?i.length:i}):function(){return u.count?i.length:i}},n)},r.Store.fn.find=function(n,r){var o=$.Deferred(),i=t.open(this.db.name,this.db.version);return i.onsuccess=function(t){var i,u=t.target.result,s=u.transaction([this.name],"readonly").objectStore(this.name);r&&r.index&&(s=s.index(r.index)),i=s.get(n),i.onsuccess=function(t){var n=t.target.result;return n===e?(o.resolve(n),u.close(),e):(o.resolve(this.create().update(n)),u.close(),e)}.bind(this),i.onerror=function(e){var t=e.target.result;o.reject(n),t.close()}}.bind(this),i.onerror=function(e){var t=e.target.result;o.reject(n),t.close()},o.promise()};var c=function(e){return{add:function(t,n){n&&(e.add(t,n).onerror=function(){console.log("errored")}),e.add(t).onerror=function(){console.log("errored")}},put:function(t,n){n&&e.put(t,n),e.put(t)},remove:function(t){e.delete(t)}}};r.Store.fn.transaction=function(){var e=[].slice.apply(arguments),n=[this].concat(e.splice(0,e.length-1)),r=e[e.length-1],o=$.Deferred(),i=t.open(this.db.name,this.db.version);return i.onsuccess=function(e){var t=e.target.result,i=n.map(function(e){return e.name}),u=t.transaction(i,"readwrite"),s=r.apply(null,n.map(function(e){return c(u.objectStore(e.name))}));u.oncomplete=function(){o.resolve(),t.close()},u.onerror=function(){s!==!1?o.reject():o.resolve(),t.close()},s===!1&&u.abort()}.bind(this),i.onerror=function(e){var t=e.target.result;o.reject(),t.close()},o.promise()},r.Record.fn.delete=function(n){var r,o=$.Deferred(),i=function(){return this.store.keyPath?this[this.store.keyPath]:"function"==typeof n?n():n?this[n]:e}.apply(this);return i?(r=t.open(this.db.name,this.db.version),r.onsuccess=function(e){var t=e.target.result,n=t.transaction([this.store.name],"readwrite").objectStore(this.store.name);n.delete(i),n.transaction.oncomplete=function(){o.resolve(i),t.close()},n.transaction.onerror=function(){o.reject(i),t.close()}}.bind(this),r.onerror=function(e){var t=e.target.result;o.reject(),t.close()},o.promise()):(o.reject("key does not setting."),o.promise())};var a=function(t,n,r){return this instanceof a?(Object.defineProperties(this,{store:{value:Object.create(null,{name:{value:t.name}})},db:{value:n}}),Object.keys(t).filter(function(e){return"keyPath"===e||"autoIncrement"===e}).forEach(function(e){Object.defineProperty(this.store,e,{value:t[e]})}.bind(this)),$.extend(Object.getPrototypeOf(this),r),e):new a(t,n,r)};a.prototype=r.Record.fn,r.Record.fn.save=function(e){var n=$.Deferred(),r=t.open(this.db.name,this.db.version);return r.onsuccess=function(t){var r,o=t.target.result,i=o.transaction([this.store.name],"readwrite").objectStore(this.store.name),u=Object.keys(this).reduce(function(e,t){return e[t]=this[t],e}.bind(this),{}),s=function(){return e?i.put(u,e):i.put(u)}();s.onsuccess=function(e){r=e.target.result},i.transaction.oncomplete=function(){n.resolve(r),o.close()},i.transaction.onerror=function(){n.reject(),o.close()}}.bind(this),r.onerror=function(e){var t=e.target.result;n.reject(),t.close()}.bind(this),Object.defineProperty(this,"promise",{writable:!0,value:n.promise()})},r.Record.fn.update=function(e){return Object.keys(e).forEach(function(t){this[t]=e[t]}.bind(this)),this},window.Gavia=r}).call(this);